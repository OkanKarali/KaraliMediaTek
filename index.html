<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gelişmiş Barkod Tarayıcı</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 1rem;
            background-color: #f0f2f5;
        }

        #app-container {
            max-width: 600px;
            width: 100%;
            background: #ffffff;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }

        h1 {
            font-size: 1.5rem;
            text-align: center;
            color: #007aff;
            margin-bottom: 1rem;
        }
        
        #reader {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ddd;
            background: #000;
        }
        
        #reader__dashboard_section_csr > div:first-child {
            display: none; /* Hide the camera selection dropdown */
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 1.5rem;
        }

        .action-button {
            flex-grow: 1;
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: bold;
            color: #ffffff;
            background: linear-gradient(to right, #007aff, #00c6ff);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        .action-button:disabled {
            background: #c7c7cc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .action-button.stop {
             background: linear-gradient(to right, #ff3b30, #ff9500);
        }
        
        #torch-button {
            background: linear-gradient(to right, #ff9500, #ffcc00);
        }
        
        #torch-button.on {
            background: linear-gradient(to right, #ffcc00, #ff9500);
        }

        #result-section {
            margin-top: 1.5rem;
            text-align: center;
        }

        #result-section h2 {
            font-size: 1.2rem;
            color: #333;
        }

        #result-box {
            background: #f0f2f5;
            padding: 1rem;
            border-radius: 8px;
            min-height: 3rem;
            font-family: "SF Mono", "Menlo", "Courier New", Courier, monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: #007aff;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s, color 0.3s;
            word-break: break-all;
        }
        
        #result-box.found {
            background-color: #34c759;
            color: #ffffff;
        }
        
        #status-text {
             margin-top: 1rem;
             color: #606770;
             min-height: 2.5rem;
        }
        
    </style>
</head>
<body>

    <div id="app-container">
        <h1>Gelişmiş Barkod Tarayıcı</h1>
        
        <div id="reader"></div>

        <div class="button-group">
            <button id="scan-button" class="action-button">Taramayı Başlat</button>
            <button id="torch-button" class="action-button" disabled>Işığı Aç</button>
        </div>

        <div id="result-section">
            <h2>Sonuç</h2>
            <div id="result-box">Kamera bekleniyor...</div>
            <p id="status-text">Hedef Barkod: <strong>8681291090066</strong></p>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <script>
        const scanButton = document.getElementById('scan-button');
        const torchButton = document.getElementById('torch-button');
        const resultBox = document.getElementById('result-box');
        const statusText = document.getElementById('status-text');
        
        let isScanning = false;
        let isTorchOn = false;
        
        const html5QrCode = new Html5Qrcode("reader");

        const onScanSuccess = (decodedText, decodedResult) => {
            const targetBarcode = '8681291090066';
            resultBox.classList.remove('found');
            
            if (decodedText === targetBarcode) {
                resultBox.textContent = `BULUNDU: ${decodedText}`;
                resultBox.classList.add('found');
                statusText.textContent = "Hedef barkod başarıyla eşleşti!";
                navigator.vibrate(200); // Vibrate on success
                stopScanning();
            } else {
                resultBox.textContent = `Bulunan: ${decodedText}`;
                statusText.textContent = "Bu barkod hedefle eşleşmiyor.";
            }
        };

        const onScanFailure = (error) => { /* Ignore */ };
        
        // **NEW**: Helper function to apply advanced settings after the camera starts
        function applyAdvancedConstraints() {
            try {
                const track = html5QrCode.getRunningTrack();
                const capabilities = track.getCapabilities();

                const constraintsToApply = {};

                // Apply continuous focus if supported
                if (capabilities.focusMode && capabilities.focusMode.includes("continuous")) {
                    constraintsToApply.focusMode = 'continuous';
                }

                // Apply ideal zoom if supported
                if (capabilities.zoom) {
                     constraintsToApply.zoom = 1.2;
                }
                
                // Only apply if there are constraints to apply
                if (Object.keys(constraintsToApply).length > 0) {
                    track.applyConstraints({
                        advanced: [constraintsToApply]
                    }).catch(e => console.log("Gelişmiş ayarlar uygulanamadı:", e));
                }
            } catch (err) {
                console.error("Gelişmiş ayarlar alınamadı:", err);
            }
        }
        
        function startScanning() {
            const config = {
                fps: 20, // Adjusted FPS
                formatsToSupport: [ Html5QrcodeSupportedFormats.EAN_13 ],
                qrbox: (viewfinderWidth, viewfinderHeight) => {
                    return {
                        width: viewfinderWidth * 0.9,
                        height: viewfinderHeight * 0.5
                    };
                }
            };
            
            scanButton.disabled = true;
            
            // **FIX**: Start with a simple, valid configuration to prevent the error.
            html5QrCode.start(
                { facingMode: "environment" }, // Use a simple, one-key object
                config,
                onScanSuccess,
                onScanFailure
            ).then(() => {
                isScanning = true;
                scanButton.textContent = 'Taramayı Durdur';
                scanButton.classList.add('stop');
                resultBox.textContent = "Barkod aranıyor...";
                scanButton.disabled = false;

                // **NEW**: Apply advanced settings after the stream has started successfully
                applyAdvancedConstraints(); 
                checkTorchCapability();

            }).catch(err => {
                 resultBox.textContent = `Hata: ${err}`;
                 scanButton.disabled = false;
            });
        }
        
        function stopScanning() {
             html5QrCode.stop().then(() => {
                isScanning = false;
                scanButton.textContent = 'Taramayı Başlat';
                scanButton.classList.remove('stop');
                resultBox.textContent = "Tarama durduruldu.";
                torchButton.disabled = true;
                torchButton.textContent = "Işığı Aç";
                isTorchOn = false;
            }).catch(err => {
                console.error("Durdurma hatası:", err);
            });
        }
        
        function checkTorchCapability() {
            try {
                 const track = html5QrCode.getRunningTrack();
                 const capabilities = track.getCapabilities();
                 if (capabilities.torch) {
                     torchButton.disabled = false;
                 } else {
                     statusText.textContent = "Bu cihazın ışık özelliği yok.";
                 }
            } catch (err) {
                 console.error("Işık özelliği kontrol hatası:", err);
                 torchButton.disabled = true;
            }
        }
        
        function toggleTorch() {
            if (isScanning && !torchButton.disabled) {
                const track = html5QrCode.getRunningTrack();
                isTorchOn = !isTorchOn;
                track.applyConstraints({
                    advanced: [{torch: isTorchOn}]
                }).then(() => {
                    torchButton.textContent = isTorchOn ? "Işığı Kapat" : "Işığı Aç";
                }).catch(e => console.log(e));
            }
        }

        scanButton.addEventListener('click', () => {
            if (isScanning) {
                stopScanning();
            } else {
                startScanning();
            }
        });
        
        torchButton.addEventListener('click', toggleTorch);

    </script>
</body>
</html>
